<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>注文履歴</title>
    <link rel="stylesheet" href="\css\OrderHistory.css">
</head>

<body>
    <form action="/logout" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /><!--CSRF トークン-->
        <button type="submit">ログアウト</button>
    </form>
    <h2>注文履歴</h2>
    <div class="table-wrapper">
        <table border="1">
            <thead>
                <tr>
                    <th class="col-title">書籍名</th>
                    <th class="col-publisher">出版社</th>
                    <th class="col-count">冊数</th>
                    <th class="col-name">名前</th>
                    <th class="col-tel">電話番号</th>
                    <th class="col-address">email</th>
                    <th class="col-isbn">ISBNコード</th>
                    <th class="col-date">承認日</th>
                    <th class="col-amount">金額</th>
                    <th class="col-status">承認状況</th>
                    <th class="col-approve">承認ボタン</th>
                    <th class="col-complete">取引状況</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="reservation : ${reservationList}">
                    <td th:text="${reservation.title}"></td>
                    <td th:text="${reservation.publisher}"></td>
                    <td th:text="${reservation.count}"></td>
                    <td th:text="${reservation.name}"></td>
                    <td th:text="${reservation.tel}"></td>
                    <td th:text="${reservation.email}"></td>
                    <td th:text="${reservation.isbnCode} ?: ''"></td>
                    <td th:text="${reservation.approvalDate} ?: '未承認'"></td>
                    <td th:text="${reservation.amount} ?: '未入力'"></td>
                    <td id="approvalStatus" th:text="${reservation.approvalStatus} ?: '未承認'"></td>

                    <!-- 承認ボタン -->
                    <!--<td th:text="">取引未完了</td>-->
                    <td>
                        <form action="/reserveappro" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="title" th:value="${reservation.title}" />
                            <input type="hidden" name="publisher" th:value="${reservation.publisher}" />
                            <input type="hidden" name="count" th:value="${reservation.count}" />
                            <input type="hidden" name="name" th:value="${reservation.name}" />
                            <button type="submit">承認</button>
                        </form>

                    </td>

                    <!-- 取引完了ボタン -->
                    <td>
                        <form action="/complete" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="id" th:value="${reservation.id}" />
                            <button type="submit" class="complete-btn"
                                th:disabled="${reservation.completed}">取引完了</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 共通ダイアログ -->
    <dialog id="trcom">
        <h5>取引を本当に確定してよろしいですか？</h5>
        <div style="margin-top:10px;">
            <button id="confirmComplete">完了</button>
            <button id="cancelComplete">キャンセル</button>
        </div>
    </dialog>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dialog = document.getElementById("trcom");
            let targetRow = null;
            let targetForm = null;
        
            // === 1️⃣ localStorage から完了済タイトル一覧を取得 ===
            let completedList = JSON.parse(localStorage.getItem("completedList") || "[]");
        
            // === 2️⃣ ページ表示時に完了状態を反映 ===
            const tbody = document.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
        
            rows.forEach(row => {
                const title = row.querySelector("td:nth-child(1)")?.textContent?.trim();
                if (completedList.includes(title)) {
                    row.classList.add("completed");
                    const btn = row.querySelector(".complete-btn");
                    if (btn) btn.disabled = true;
                }
            });
        
            // === 3️⃣ 完了済行を下に並べ替え ===
            completedList.forEach(title => {
                const matchRow = rows.find(row => row.querySelector("td:nth-child(1)")?.textContent?.trim() === title);
                if (matchRow) tbody.appendChild(matchRow);
            });
        
            // === 4️⃣ 「取引完了」ボタン押下時 ===
            document.querySelectorAll(".complete-btn").forEach(btn => {
                btn.addEventListener("click", function (e) {
                    e.preventDefault();
                    targetRow = btn.closest("tr");
                    targetForm = btn.closest("form");
                    dialog.showModal();
                });
            });
        
            // === 5️⃣ 「キャンセル」ボタン ===
            document.getElementById("cancelComplete").addEventListener("click", () => {
                dialog.close();
                targetRow = null;
                targetForm = null;
            });
        
            // === 6️⃣ 「完了」ボタン ===
            document.getElementById("confirmComplete").addEventListener("click", () => {
                if (!targetForm || !targetRow) return;
        
                const formData = new FormData(targetForm);
                fetch(targetForm.action, {
                    method: targetForm.method,
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error("サーバーエラー");
                    return response.text();
                })
                .then(() => {
                    const title = targetRow.querySelector("td:nth-child(1)")?.textContent?.trim();
                    if (!title) return;
        
                    // グレーアウト + ボタン無効化
                    targetRow.classList.add("completed");
                    targetRow.querySelector(".complete-btn").disabled = true;
        
                    // === 完了リストに追加 ===
                    if (!completedList.includes(title)) {
                        completedList.push(title);
                        localStorage.setItem("completedList", JSON.stringify(completedList));
                    }
        
                    // 行を一番下に移動
                    tbody.appendChild(targetRow);
        
                    dialog.close();
                })
                .catch(err => {
                    console.error("通信エラー:", err);
                    dialog.close();
                });
            });
        });
        </script>
        
        
</body>

</html>